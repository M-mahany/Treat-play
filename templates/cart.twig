{% extends "layout.twig" %}

{% block top_links %}

<style>
    #cartPage {
        padding-bottom: 50px;
        background-color: #F9F6BD;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;

    }

    .cartTitle {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        color: #787878;
        height: 130px;
        font-size: 20px;
        font-weight: 600;
        border-bottom: 1px solid #787878;
    }

    .cartMainWrapper {
        gap: 8%;
        width: 100%;
        display: flex;
        padding: 0 7% 0 7%;
        flex-wrap: wrap;
    }

    #leftBoxCart {
        display: flex;
        flex-direction: column;
        flex: 1.6;
    }

    .productWrapper {
        margin-top: 30px;
        padding-bottom: 24px;
        border-bottom: 1px solid #787878;
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .topLeft {
        gap: 4%;
        flex-direction: row;
        display: flex;
        justify-content: space-between;
        width: 100%;
    }

    .productBox {
        gap: 20px;
        display: flex;
        flex-direction: row;
    }

    .imgBox {
        background-color: #D9D9D9;
        min-width: 220px;
        max-width: 220px;
        height: 150px;
    }

    .imgBox img {
        width: 100%;
        height: 150px;
    }

    .descBox {
        display: flex;
        flex-direction: column;
    }

    .descBox p {
        margin-bottom: 18px;
        font-size: 20px;
        color: #787878;
        font-weight: 600;
    }

    .descBox span {
        font-size: 13px;
        color: black;
    }

    .productMoreDetails {
        display: flex;
        flex-direction: column;
    }

    .quantityBox {
        padding-top: 10px;
        width: 210px;
        display: flex;
        flex-direction: column;
    }

    .quantity {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1.5px solid #9B9B9B;
        height: 50px;
    }

    .quantityNo {
        padding: 13px;
        height: 100%;
        text-align: center;
        color: #9B9B9B;
        font-size: 22px;
    }

    .decrement-count {
        cursor: pointer;
        left: 0px;
        position: absolute;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #9B9B9B;
        width: 25%;
        height: 100%;
        border-right: 1px solid grey;
    }

    .decrement-count.disabled {
        cursor: not-allowed;
        pointer-events: none;
    }

    .increment-count {
        cursor: pointer;
        position: absolute;
        right: 0px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #9B9B9B;
        width: 25%;
        height: 100%;
        border-left: 1px solid grey;
    }

    .increment-count.disabled {
        cursor: not-allowed;
        pointer-events: none;
    }

    .BottomLeft {
        width: 100%;
        display: flex;
        flex-direction: row;
        gap: 62px;
    }

    .BottomLeft a {
        color: black;
        text-decoration: none;
        font-size: 18px;
        font-weight: 300;
        cursor: pointer;
    }

    #totalCartDiv {
        width: 77.5%;
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #totalCartDiv span {
        color: #787878;
        font-weight: 600;
        font-size: 20px;
    }

    .rightBoxCart {
        height: 100%;
        display: flex;
        flex-direction: column;
        margin-top: 30px;
        flex: 1;
    }

    .promoDiv {
        margin-top: 30px;
        justify-content: space-between;
        border: 1px solid #9B9B9B;
        width: 100%;
        height: 50px;
        display: flex;
        flex-direction: row;
    }

    .promoDiv input {
        background-color: #F9F6BD;
        border: none;
        width: calc(100% - 150px);
    }

    .promoDiv button {
        font-size: 18px;
        font-weight: 300;
        border: none;
        width: 150px;
        height: 50px;
        color: #F9F6BD;
        background-color: #06371F;
    }

    .divDetails {
        width: 100%;
        margin-top: 30px;
        font-size: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .divDetails1 {
        width: 100%;
        font-size: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-bottom: 30px;
        border-bottom: 0.75px solid #787878;
        margin-bottom: 30px;
    }

    .lastDetail {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #787878;
        font-size: 20px;
        font-weight: 600;
    }

    .buyButton {
        margin-top: 50px;
        background-color: #06371F;
        width: 100%;
        height: 50px;
        border: none;
        color: #F9F6BD;
        font-weight: 500;
        font-size: 20px;
    }

    .buyButton.disabled {
        background-color: #787878;
        cursor: none;
        pointer-events: none;
    }

    .alert {
        position: fixed;
        top: 10px;
    }

    .alert.hidden {
        display: none;
    }

    #continueShopDiv {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    #continueShopDiv a {
        cursor: pointer;
        font-size: 20px;
        font-weight: 400;
        height: 50px;
        width: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-decoration: none;
        border: 1px solid #06371F;
        color: #06371F;
    }

    @media screen and (max-width: 900px) {
        .topLeft {
            flex-wrap: wrap;
        }

        .BottomLeft {
            margin-top: 20px;
        }

        .productBox {
            flex-direction: column;
        }
    }
</style>
{% endblock %}
{% block header %} {{ include('header.twig') }} {% endblock %}
{% block main_content %}
<div id="cartPage">
    <div class="alert hidden" role="alert">
        <span id="alertMessage">
            This is a success alert with Give it a click if you like.
        </span>
    </div>
    <div class="cartTitle">
        <p>
            My Cart
        </p>
    </div>
    <div class="cartMainWrapper">
        <div id="leftBoxCart">

        </div>

        <div class="rightBoxCart">
            <span style="font-size:13px;">
                Enter promo code
            </span>
            <div class="promoDiv">
                <input class="send-coupon" type="text" placeholder="Enter you coupon here" />
                <button type="button" onclick="sendCoupon()">
                    Submit
                </button>
            </div>
            {% if cart.coupon.message %}
            <div style="display: flex;margin-top:10px;">
                <span>{{ cart.coupon.message }}</span>&nbsp;
                <a style="color: inherit; cursor: pointer" onclick="deleteCoupon()">
                    <i class="material-icons" style="color:darkred; font-size:20px;">delete</i>
                </a>
            </div>
            {% endif %}
            <div class="divDetails">
                <span>
                    Total Before Discount
                </span>
                <span id="totalBefore">

                </span>
            </div>
            <div class="divDetails">
                <span>
                    Discount
                </span>
                <span id="totalDiv">
                </span>
            </div>
            <div class="divDetails1">
                {# <span>
                    Tax
                </span>
                <span>
                    $39.99
                </span> #}
            </div>
            <div class="lastDetail">
                <span>
                    Estimated Total
                </span>
                <span id="cartTotal">

                </span>
            </div>
            <button class="buyButton disabled"
                onclick="window.location.href='{% if customer %}/checkout/choose-address-and-shipping{% else %}/auth/login?redirect_to=/checkout/choose-address-and-shipping{% endif %}';">
                Checkout
            </button>
            <span style="font-size: 13px; font-weight:300; text-align:center;margin-top:14px;color:black;">
                Easy & Free Exchange
            </span>
        </div>
    </div>
</div>
{{ zidapi_script|raw }}
<script>
    function fetchingCart() {
        zid.store.cart.fetch().then(function (response) {
            if (response.status === 'success') {
                let data = response.data
                let cartProductsData = data.cart.products
                document.getElementById('leftBoxCart').innerHTML = cartProductsData.map((product) =>
                    `
                <div class="productWrapper">
                    <div class="topLeft">
                        <div class="productBox">
                            <div class="imgBox">
                                <img src="${product.images[0].thumbs.small}" alt="${product.name}" />
                            </div>
                            <div class="descBox">
                                <p>
                                    ${product.name}
                                </p>
                                <span>
                                  
                                </span>
                                <span>
                                    
                                </span>
                            </div>
                        </div>
                        <div class="productMoreDetails">
                            <span style="font-size: 13px;">
                                Each
                            </span>
                            <span style="color:#787878; font-size:20px; font-weight:600;">       
                                ${product.net_sale_price_string ? product.net_sale_price_string : product.net_price_string}
                            </span>
                            <div class="quantityBox">
                                <span style="font-size: 13px; padding-bottom:13px;">
                                    Quantity:
                                </span>
                                <div class="quantity">
                                    <span class="decrement-count"
                                        onclick="handleclick(event,'${product.product_id}','${product.id}')">
                                        <i class="material-icons">remove</i>
                                    </span>
                                    <p class="quantityNo">
                                        ${product.quantity}
                                    </p>
                                    <span class="increment-count"
                                    onclick="handleclick(event,'${product.product_id}','${product.id}')">
                                        <i class="material-icons">add</i>
                                    </span>
                                </div>
                            </div>
                            <span style="font-size: 13px;margin-top:18px;">
                                Total
                            </span>
                            <span style="color:#787878; font-size:20px; font-weight:600;margin-top:5px;">
                                ${product.total_string}
                            </span>
                        </div>
                    </div>
                    <div class="BottomLeft">
                        <a onclick="handleDelele('${product.id}', '${product.product_id}')">
                            Remove
                        </a>
                        <a href="#">
                        </a>
                    </div>
                </div>
            `).join('');
                let estimatedTotalCartDiv = document.getElementById('cartTotal')
                let totalBefore = document.getElementById('totalBefore')
                if (data.cart.products.length > 0) {
                    $('.buyButton').removeClass('disabled')
                    document.getElementById('leftBoxCart').innerHTML += `
                 <div id="totalCartDiv">
                    <span>
                    ${data.cart.products_count} item(s)
                     </span>
                        <span>
                    ${data.cart.products_subtotal} SAR
                        </span>
                 </div>`;
                    estimatedTotalCartDiv.innerHTML = data.cart.totals[1].value_string
                    totalBefore.innerHTML = data.cart.totals[1].value_string
                    if (document.getElementById('continueShopDiv') !== null) {
                        document.getElementById('continueShopDiv').style.display = 'none'
                    }
                    setCartTotalAndBadge(response.data.cart);
                } else {
                    totalBefore.innerHTML = '0.00 SAR';
                    estimatedTotalCartDiv.innerHTML = '0.00 SAR';
                    $('.buyButton').addClass('disabled')
                    document.getElementById('leftBoxCart').innerHTML += `
                    <div id="continueShopDiv" style="display:flex">
                        <span style="font-size: 14px;color:#787878;margin-bottom:5px;">
                            Empty Cart!
                        </span>
                        <a href="/products">
                            Continue Shopping
                        </a>
                    </div>`;
                }
                let discountArray = [];
                cartProductsData.forEach((product) => {
                    if (product.total_before) {
                        discountArray.push(product.total_before - product.total)
                    }
                })
                let totalDiv = document.getElementById('totalDiv')
                if (discountArray.length > 0) {
                    let discountTotal = discountArray.reduce((a, b) => a + b)
                    totalBefore.innerHTML = (parseInt(discountTotal) + parseInt(data.cart.totals[1].value)) + ' ' + 'SAR'
                    totalDiv.innerHTML = discountTotal + ' ' + 'SAR'
                } else {
                    totalDiv.innerHTML = '0.00 SAR';
                }

            }
        })
    }
    fetchingCart()
    function showandHideAlert() {
        if ($('.alert').hasClass('alert-success')) {
            setTimeout(() => {
                $('.alert').removeClass('alert-success').addClass('hidden')
            }, 5000)
        } else {
            if ($('.alert').hasClass('alert-danger')) {
                setTimeout(() => {
                    $('.alert').removeClass('alert-danger').addClass('hidden')
                }, 5000)
            }
        }
    }
    function sendCoupon() {
        zid.store.cart.redeemCoupon($('.send-coupon').val())
            .then(function (response) {
                if (response.status === 'success') {
                    $('#alertMessage').html(response.data.message)
                    $('.alert').removeClass('hidden').addClass('alert-success')
                    showandHideAlert()
                    window.location.reload();
                } else {
                    if (response.status === "The given data was invalid.") {
                        $('#alertMessage').html("Please enter Coupon before submitting")
                        $('.alert').removeClass('hidden').addClass('alert-danger')
                        showandHideAlert()
                    } else {
                        $('#alertMessage').html(response.data.message)
                        $('.alert').removeClass('hidden').addClass('alert-danger')
                        showandHideAlert()
                    }

                }
            })
    }
    function deleteCoupon() {
        zid.store.cart.removeCoupon().then(function (response) {
            if (response.status === 'success') {
                $('#alertMessage').html('Your Review is submitted Successfully!')
                $('.alert').removeClass('hidden').addClass('alert-success')
                showandHideAlert()
                window.location.reload();
            } else {
                $('#alertMessage').html(response.data.message)
                $('.alert').removeClass('hidden').addClass('alert-danger')
                showandHideAlert()
            }
        })
    }
    function handleclick(event, product_id, cart_product_id) {
        let mainWrapper = event.target.parentElement.parentElement;
        let newQuantity = mainWrapper.getElementsByTagName('p')[0]
        let count = parseInt(newQuantity.innerHTML)
        if (event.target.innerText === 'remove') {
            count--
        } else {
            count++
        }
        if (count > 0) {
            $('.decrement-count').addClass('disabled')
            $('.increment-count').addClass('disabled')
            zid.store.cart.updateProduct(cart_product_id, count, product_id).then(function (response) {
                if (response.status === 'success') {
                    newQuantity.innerHTML = count
                    fetchingCart()
                    $('.decrement-count').removeClass('disabled')
                    $('.increment-count').removeClass('disabled')
                } else {
                    $('#alertMessage').html(response.data.message)
                    $('.alert').removeClass('hidden').addClass('alert-danger')
                    showandHideAlert()
                    $('.decrement-count').removeClass('disabled')
                    $('.increment-count').removeClass('disabled')
                }
            })
        } else {
            handleDelele(cart_product_id, product_id)
        }
    }
    function handleDelele(cart_product_id, product_id) {
        $('.decrement-count').addClass('disabled')
        $('.increment-count').addClass('disabled')
        zid.store.cart.removeProduct(cart_product_id, product_id).then(function (response) {
            if (response.status === 'success') {
                fetchingCart()
                $('.decrement-count').removeClass('disabled')
                $('.increment-count').removeClass('disabled')
            } else {
                $('#alertMessage').html(response.data.message)
                $('.alert').removeClass('hidden').addClass('alert-danger')
                showandHideAlert()
            }
        })
    }
</script>
{% endblock %}